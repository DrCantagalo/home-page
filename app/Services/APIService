<?php

namespace App\Services;

use Illuminate\Http\Request;

class APIService
{
    public function registerinstallation(Request $request)
    {
        $hash = $request->installation_hash;
        $siteUrl = $request->site_url;
        $version = $request->package_version;
        $clientIp = $request->ip();

        $installation = Installation::where('installation_hash', $hash)->first();

        if ($installation) {
            return response()->json([
                'status' => 'existing',
                'installation_code' => $installation->installation_code,
                'api_token' => Crypt::decrypt($installation->api_token_enc),
            ]);
        }

        $ipMatch = $this->checkIpMatchesUrl($clientIp, $siteUrl);

        if(!$ipmatch) {
            return response()->json(["aqui retorno pedindo adicionar txt"]);
        }

        $apiToken = Str::random(64);
        $installationCode = strtoupper(Str::random(12));

        // 4. Criar registro
        $installation = Installation::create([
            'installation_hash' => $hash,
            'site_url' => $siteUrl,
            'package_version' => $version,
            'client_ip' => $clientIp,
            'installation_code' => $installationCode,
            'api_token' => hash('sha256', $apiToken),
            'api_token_enc' => Crypt::encrypt($apiToken),
        ]);

        return response()->json([
            'status' => 'created',
            'installation_code' => $installationCode,
            'api_token' => $apiToken,
            'ip_match' => $ipMatch,
        ]);
    }

    private function checkIpMatchesUrl($clientIp, $url)
    {
        $host = parse_url($url, PHP_URL_HOST);

        if (!$host) {
            return false;
        }

        $dnsRecords = dns_get_record($host, DNS_A);
        $validIps = array_column($dnsRecords, 'ip');

        return in_array($clientIp, $validIps);
    }
}